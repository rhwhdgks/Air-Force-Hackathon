<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>강남구 쓰레기통 최적배치 (DE + SSE)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src=//dapi.kakao.com/v2/maps/sdk.js?appkey=e8766bd88588ae6eb6f111b400b5c205&libraries=services,drawing"></script>
  <style>html,body,#map{margin:0;padding:0;width:100%;height:100%;}</style>
</head>
<body class="h-screen flex">

<!-- ▽ 컨트롤 패널 ▽ -->
<aside class="w-64 bg-white p-4 space-y-4 overflow-auto">
  <h2 class="text-lg font-medium">배치 설정</h2>

  <div>
    <label>개수: <span id="cntVal">1000</span></label>
    <input id="cntSlider" type="range" min="100" max="1500" step="100" value="1000" class="w-full">
  </div>

  <div>
    <label>반경(m):
      <input id="rInput" type="number" value="50" class="w-20 border rounded text-right">
    </label>
  </div>

  <div>
    <label>MAX/위치:
      <input id="maxInput" type="number" value="1" class="w-20 border rounded text-right">
    </label>
  </div>

  <hr>

  <div>전체 쓰레기양: <span id="totalWaste">0</span></div>
  <div>진행:
    <progress id="progBar" max="100" value="0" class="w-full"></progress>
    <span id="progLabel">0%</span>
  </div>
  <div>총 감소량: <span id="totalReduction">0</span></div>

  <button id="runBtn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
    실행 (DE + SSE)
  </button>
</aside>

<!-- ▽ 지도 ▽ -->
<div id="map" class="flex-1"></div>

<script>
/* ── 지도 초기화 ─────────────────────────── */
const map = new kakao.maps.Map(document.getElementById('map'), {
  center: new kakao.maps.LatLng(37.5172,127.0473), level: 5
});

/* ── UI refs ────────────────────────────── */
const cntSlider = document.getElementById('cntSlider');
const cntVal    = document.getElementById('cntVal');
const rInput    = document.getElementById('rInput');
const maxInput  = document.getElementById('maxInput');
const totalWaste= document.getElementById('totalWaste');
const totalRed  = document.getElementById('totalReduction');
const progBar   = document.getElementById('progBar');
const progLabel = document.getElementById('progLabel');
const runBtn    = document.getElementById('runBtn');

cntSlider.addEventListener('input', () => cntVal.textContent = cntSlider.value);

/* ── 50 m 예측값 로드 ────────────────────── */
let sidewalkData = [], overlays = [];
fetch('/map/sidewalk_waste_estimates_50.json')
  .then(r => {
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  })
  .then(d => {
    sidewalkData = d;
    totalWaste.textContent =
      Math.floor(d.reduce((s,p)=>s+p.waste_estimate,0)).toLocaleString();
  })
  .catch(console.error);

/* ── 진행바 helper ───────────────────────── */
function setProgress(v){
  progBar.value = v;
  progLabel.textContent = v + '%';
}

/* ── 실행 버튼 ( SSE 스트림 ) ────────────── */
runBtn.addEventListener('click', () => {
  // 초기화
  overlays.forEach(o => o.setMap(null)); overlays = [];
  setProgress(0); totalRed.textContent = '0';

  const P   = +cntSlider.value;
  const R   = +rInput.value;
  const MAX = +maxInput.value;

  const src = new EventSource(`/api/runDEStream?p=${P}&r=${R}&max=${MAX}`);

  src.addEventListener('progress', e => {
    setProgress(+e.data);              // 10,20,…100
  });

  src.addEventListener('result', e => {
    const data = JSON.parse(e.data);
    setProgress(100);
    totalRed.textContent = data.totalReduction.toLocaleString();

    data.selected.forEach(idx => {
      const p = sidewalkData[idx];
      const ov = new kakao.maps.CustomOverlay({
        position: new kakao.maps.LatLng(p.lat, p.lng),
        content: `<div class="bg-orange-500 text-white text-xs font-bold
                          rounded-full w-4 h-4 flex items-center justify-center">
                    ${data.bins[idx]}
                  </div>`,
        yAnchor: 1
      });
      ov.setMap(map);
      overlays.push(ov);
    });
    src.close();
  });

  src.onerror = err => { console.error(err); src.close(); setProgress(0); };
});
</script>
</body>
</html>
